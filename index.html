<script>
    const BIN_ID = "67aa03d1ad19ca34f8fe1222";
    const API_KEY = "$2a$10$WDxqMldaCPRWe5QIkJyqaOoANokaYdmzbEnVOqet0yFLu7Fy/2Odm";
    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    async function fetchData() {
        try {
            const response = await axios.get(API_URL, { headers: { "X-Master-Key": API_KEY } });
            const data = response.data.record;

            // Ensure messages exist before rendering
            if (!data.messages) {
                data.messages = []; // Initialize if not present
            }

            renderForest(data.trees);
            renderMessages(data.messages);
        } catch (error) {
            console.error("Error fetching data", error);
        }
    }

    async function saveData(data) {
        try {
            await axios.put(API_URL, data, { headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY } });
        } catch (error) {
            console.error("Error saving data", error);
        }
    }

    function renderForest(trees) {
        const forest = document.getElementById("forest");
        forest.innerHTML = "";
        for (const user in trees) {
            const treeContainer = document.createElement("div");
            treeContainer.classList.add("tree-container");
            treeContainer.innerHTML = `
                <div class='tree'>${trees[user]}</div>
                <p>${user}</p>
            `;
            forest.appendChild(treeContainer);
        }
    }

    function renderMessages(messages) {
        const messageList = document.getElementById("messages");
        messageList.innerHTML = "";
        messages.forEach(msg => {
            const newMessage = document.createElement("li");
            newMessage.textContent = msg;
            messageList.appendChild(newMessage);
        });
    }

    async function postMessage() {
        const messageInput = document.getElementById("message");
        const messageText = messageInput.value.trim();
        if (!messageText) return;

        const response = await axios.get(API_URL, { headers: { "X-Master-Key": API_KEY } });
        const data = response.data.record;

        // Ensure messages exist before pushing
        if (!data.messages) {
            data.messages = []; // Initialize if not present
        }

        data.messages.push(messageText);
        await saveData(data);
        fetchData();
        messageInput.value = "";
    }

    // Define the setUsername function
    function setUsername() {
        const usernameInput = document.getElementById("username");
        const username = usernameInput.value.trim();
        if (username) {
            // Save the username (here we just show an alert, but you can store it in your backend or local storage)
            alert(`Username saved: ${username}`);
            usernameInput.value = ""; // Clear input field
        } else {
            alert("Please enter a valid username.");
        }
    }

    fetchData();
</script>
